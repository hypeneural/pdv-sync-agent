$Out = "C:\diagnostico_turnos_resultado.txt"; $S = "localhost\HIPER"; function Q($db, $q) { try { $c = New-Object System.Data.SqlClient.SqlConnection("Server=$S;Database=$db;Integrated Security=True;TrustServerCertificate=True;Connection Timeout=10;"); $c.Open(); $cmd = $c.CreateCommand(); $cmd.CommandText = $q; $cmd.CommandTimeout = 30; $a = New-Object System.Data.SqlClient.SqlDataAdapter($cmd); $d = New-Object System.Data.DataSet; [void]$a.Fill($d); $c.Close(); return $d.Tables[0] }catch { return "ERRO: $($_.Exception.Message)" } }; function W($t, $d, $l) { "=" * 70 | Out-File $Out -Append; "  $t" | Out-File $Out -Append; "=" * 70 | Out-File $Out -Append; if ($d -is [string]) { "  $l => $d" | Out-File $Out -Append }elseif ($null -eq $d -or $d.Rows.Count -eq 0) { "  $l => (VAZIO - 0 resultados)" | Out-File $Out -Append }else { "  $l ($($d.Rows.Count) rows):" | Out-File $Out -Append; $d | Format-Table -AutoSize | Out-String | Out-File $Out -Append } }; "" | Set-Content $Out; "DIAGNOSTICO TURNOS PDV vs GESTAO" | Out-File $Out -Append; "Data: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File $Out -Append; "Machine: $env:COMPUTERNAME" | Out-File $Out -Append; "Server: $S" | Out-File $Out -Append; "" | Out-File $Out -Append; W "TESTE 1: CONECTIVIDADE" (Q "HiperPdv" "SELECT @@SERVERNAME AS srv, DB_NAME() AS db") "HiperPdv"; W "TESTE 1: CONECTIVIDADE" (Q "Hiper" "SELECT @@SERVERNAME AS srv, DB_NAME() AS db") "Gestao"; W "TESTE 2: COLUNAS TURNO (HiperPdv)" (Q "HiperPdv" "SELECT COLUMN_NAME,DATA_TYPE,IS_NULLABLE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='turno' ORDER BY ORDINAL_POSITION") "turno_pdv"; W "TESTE 2: COLUNAS TURNO (Gestao)" (Q "Hiper" "SELECT COLUMN_NAME,DATA_TYPE,IS_NULLABLE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='turno' ORDER BY ORDINAL_POSITION") "turno_gestao"; W "TESTE 3A: ULTIMOS 15 TURNOS (HiperPdv)" (Q "HiperPdv" "SELECT TOP 15 CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.id_ponto_venda,t.sequencial,t.fechado,t.data_hora_inicio,t.data_hora_termino,t.id_usuario,u.nome AS nome_op,u.login AS login_op FROM dbo.turno t LEFT JOIN dbo.usuario u ON u.id_usuario=t.id_usuario ORDER BY t.data_hora_inicio DESC") "turnos_pdv"; W "TESTE 3B: ULTIMOS 15 TURNOS (Gestao)" (Q "Hiper" "SELECT TOP 15 CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.id_ponto_venda,t.sequencial,t.fechado,t.data_hora_inicio,t.data_hora_termino,t.id_usuario,u.nome AS nome_op,u.login AS login_op FROM dbo.turno t LEFT JOIN dbo.usuario u ON u.id_usuario=t.id_usuario ORDER BY t.data_hora_inicio DESC") "turnos_gestao"; $tp = Q "HiperPdv" "SELECT TOP 20 CONVERT(VARCHAR(36),id_turno) AS id_turno FROM dbo.turno ORDER BY data_hora_inicio DESC"; if ($tp -isnot [string] -and $tp.Rows.Count -gt 0) { $ids = ($tp.Rows | % { "'$($_.id_turno)'" }) -join ","; W "TESTE 4 (PRINCIPAL): TURNOS PDV QUE EXISTEM NO GESTAO" (Q "Hiper" "SELECT CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.sequencial,t.fechado,t.data_hora_inicio,'ENCONTRADO' AS status FROM dbo.turno t WHERE CONVERT(VARCHAR(36),t.id_turno) IN ($ids) ORDER BY t.data_hora_inicio DESC") "pdv_no_gestao"; $fg = Q "Hiper" "SELECT COUNT(*) AS found FROM dbo.turno WHERE CONVERT(VARCHAR(36),id_turno) IN ($ids)"; if ($fg -isnot [string]) { $f = $fg.Rows[0].found; $t = $tp.Rows.Count; "" | Out-File $Out -Append; "  >>> RESULTADO: $f de $t turnos do PDV encontrados no Gestao" | Out-File $Out -Append; if ($f -eq $t) { "  >>> CONCLUSAO: HIPOTESE A - IDs SAO COMPARTILHADOS (replicados entre DBs)" | Out-File $Out -Append }elseif ($f -eq 0) { "  >>> CONCLUSAO: HIPOTESE B - IDs SAO DIFERENTES (independentes)" | Out-File $Out -Append }else { "  >>> CONCLUSAO: PARCIAL - $f de $t compartilhados" | Out-File $Out -Append } } }; $tg = Q "Hiper" "SELECT TOP 20 CONVERT(VARCHAR(36),id_turno) AS id_turno FROM dbo.turno ORDER BY data_hora_inicio DESC"; if ($tg -isnot [string] -and $tg.Rows.Count -gt 0) { $ids2 = ($tg.Rows | % { "'$($_.id_turno)'" }) -join ","; W "TESTE 4B: TURNOS GESTAO QUE EXISTEM NO PDV (inverso)" (Q "HiperPdv" "SELECT CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.sequencial,t.fechado,t.data_hora_inicio,'ENCONTRADO' AS status FROM dbo.turno t WHERE CONVERT(VARCHAR(36),t.id_turno) IN ($ids2) ORDER BY t.data_hora_inicio DESC") "gestao_no_pdv"; $fg2 = Q "HiperPdv" "SELECT COUNT(*) AS found FROM dbo.turno WHERE CONVERT(VARCHAR(36),id_turno) IN ($ids2)"; if ($fg2 -isnot [string]) { $f2 = $fg2.Rows[0].found; $t2 = $tg.Rows.Count; "  >>> INVERSO: $f2 de $t2 turnos do Gestao encontrados no PDV" | Out-File $Out -Append } }; W "TESTE 4C: TOTAL TURNOS EM CADA BANCO" (Q "HiperPdv" "SELECT 'HiperPdv' AS banco, COUNT(*) AS total_turnos, SUM(CASE WHEN fechado=1 THEN 1 ELSE 0 END) AS fechados FROM dbo.turno UNION ALL SELECT 'Gestao', COUNT(*), SUM(CASE WHEN fechado=1 THEN 1 ELSE 0 END) FROM [Hiper].dbo.turno") "contagem"; $ho = Q "Hiper" "SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='operacao_pdv' AND COLUMN_NAME='origem'"; if ($ho -isnot [string] -and $ho.Rows.Count -gt 0) { W "TESTE 5A: VENDAS POR ORIGEM (Gestao)" (Q "Hiper" "SELECT origem,CASE origem WHEN 0 THEN 'PDV/Caixa' WHEN 1 THEN 'Tipo1' WHEN 2 THEN 'Loja' ELSE CAST(origem AS VARCHAR) END AS tipo,COUNT(*) AS total FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 GROUP BY origem ORDER BY origem") "por_origem"; W "TESTE 5B: ULTIMAS 15 VENDAS LOJA (origem=2)" (Q "Hiper" "SELECT TOP 15 op.id_operacao,CONVERT(VARCHAR(36),op.id_turno) AS id_turno_loja,op.id_usuario,op.id_filial,op.data_hora_inicio,op.data_hora_termino,op.origem,u.nome AS vendedor,u.login AS login_vend FROM dbo.operacao_pdv op LEFT JOIN dbo.usuario u ON u.id_usuario=op.id_usuario WHERE op.operacao=1 AND op.cancelado=0 AND op.origem=2 AND op.data_hora_termino IS NOT NULL ORDER BY op.data_hora_termino DESC") "vendas_loja"; $vl = Q "Hiper" "SELECT TOP 10 CONVERT(VARCHAR(36),op.id_turno) AS id_turno FROM dbo.operacao_pdv op WHERE op.operacao=1 AND op.cancelado=0 AND op.origem=2 AND op.data_hora_termino IS NOT NULL AND op.id_turno IS NOT NULL ORDER BY op.data_hora_termino DESC"; if ($vl -isnot [string] -and $vl.Rows.Count -gt 0) { $idsLoja = ($vl.Rows | % { "'$($_.id_turno)'" } | Select-Object -Unique) -join ","; W "TESTE 5C: TURNOS DE VENDAS LOJA - EXISTEM NO GESTAO?" (Q "Hiper" "SELECT CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.sequencial,t.fechado,t.data_hora_inicio,t.data_hora_termino FROM dbo.turno t WHERE CONVERT(VARCHAR(36),t.id_turno) IN ($idsLoja)") "loja_turnos_gestao"; W "TESTE 5D: MESMOS TURNOS DE VENDAS LOJA - EXISTEM NO PDV?" (Q "HiperPdv" "SELECT CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.sequencial,t.fechado,t.data_hora_inicio,t.data_hora_termino FROM dbo.turno t WHERE CONVERT(VARCHAR(36),t.id_turno) IN ($idsLoja)") "loja_turnos_pdv" } }else { "  AVISO: coluna 'origem' NAO existe em operacao_pdv do Gestao" | Out-File $Out -Append }; W "TESTE 6: CONTADORES GERAIS" (Q "HiperPdv" "SELECT 'HiperPdv' AS banco,(SELECT COUNT(*) FROM dbo.turno) AS turnos,(SELECT COUNT(*) FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0) AS vendas,(SELECT COUNT(*) FROM dbo.usuario) AS usuarios,(SELECT COUNT(*) FROM dbo.produto) AS produtos UNION ALL SELECT 'Gestao',(SELECT COUNT(*) FROM [Hiper].dbo.turno),(SELECT COUNT(*) FROM [Hiper].dbo.operacao_pdv WHERE operacao=1 AND cancelado=0),(SELECT COUNT(*) FROM [Hiper].dbo.usuario),(SELECT COUNT(*) FROM [Hiper].dbo.produto)") "contadores"; W "TESTE 7: STORE INFO (ponto_venda)" (Q "HiperPdv" "SELECT id_ponto_venda,nome,cnpj FROM dbo.ponto_venda") "loja"; W "TESTE 8A: TIPOS OPERACAO (HiperPdv)" (Q "HiperPdv" "SELECT operacao,CASE operacao WHEN 0 THEN 'Abertura' WHEN 1 THEN 'Venda' WHEN 3 THEN 'Sangria' WHEN 4 THEN 'FaltaCaixa' WHEN 8 THEN 'Raro' WHEN 9 THEN 'Fechamento' ELSE CAST(operacao AS VARCHAR) END AS tipo,COUNT(*) AS total FROM dbo.operacao_pdv WHERE cancelado=0 GROUP BY operacao ORDER BY operacao") "ops_pdv"; W "TESTE 8B: TIPOS OPERACAO (Gestao)" (Q "Hiper" "SELECT operacao,CASE operacao WHEN 0 THEN 'Abertura' WHEN 1 THEN 'Venda' WHEN 3 THEN 'Sangria' WHEN 4 THEN 'FaltaCaixa' WHEN 8 THEN 'Raro' WHEN 9 THEN 'Fechamento' ELSE CAST(operacao AS VARCHAR) END AS tipo,COUNT(*) AS total FROM dbo.operacao_pdv WHERE cancelado=0 GROUP BY operacao ORDER BY operacao") "ops_gestao"; W "TESTE 9: MEIOS PAGAMENTO (finalizador_pdv)" (Q "HiperPdv" "SELECT id_finalizador,nome FROM dbo.finalizador_pdv ORDER BY id_finalizador") "meios_pdv"; W "TESTE 9B: MEIOS PAGAMENTO (Gestao)" (Q "Hiper" "SELECT id_finalizador,nome FROM dbo.finalizador_pdv ORDER BY id_finalizador") "meios_gestao"; W "TESTE 10: VENDAS LOJA COM id_turno NULL" (Q "Hiper" "SELECT COUNT(*) AS sem_turno FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND origem=2 AND id_turno IS NULL") "null_turno"; W "TESTE 11: COLISAO id_operacao ENTRE PDV E GESTAO" (Q "HiperPdv" "SELECT TOP 10 p.id_operacao, p.data_hora_termino AS pdv_data, g.data_hora_termino AS gestao_data FROM [HiperPdv].dbo.operacao_pdv p JOIN [Hiper].dbo.operacao_pdv g ON g.id_operacao=p.id_operacao WHERE p.operacao=1 AND p.cancelado=0 AND g.operacao=1 AND g.cancelado=0 AND g.origem=2 ORDER BY p.data_hora_termino DESC") "colisao"; W "TESTE 12: FECHAMENTO (op=9) E FALTA (op=4) EXISTEM NO GESTAO?" (Q "Hiper" "SELECT operacao,CASE operacao WHEN 4 THEN 'FaltaCaixa' WHEN 9 THEN 'Fechamento' END AS tipo,COUNT(*) AS total,MIN(data_hora_termino) AS primeiro,MAX(data_hora_termino) AS ultimo FROM dbo.operacao_pdv WHERE cancelado=0 AND operacao IN (4,9) GROUP BY operacao") "fechamento_gestao"; W "TESTE 13: ULTIMAS 5 VENDAS PDV COM ITENS E PAGAMENTOS" (Q "HiperPdv" "SELECT TOP 5 op.id_operacao,CONVERT(VARCHAR(36),op.id_turno) AS turno,op.data_hora_termino,(SELECT COUNT(*) FROM dbo.item_operacao_pdv i WHERE i.id_operacao=op.id_operacao AND i.cancelado=0) AS qtd_itens,(SELECT ISNULL(SUM(i.valor_total_liquido),0) FROM dbo.item_operacao_pdv i WHERE i.id_operacao=op.id_operacao AND i.cancelado=0) AS total_itens,(SELECT COUNT(*) FROM dbo.finalizador_operacao_pdv f WHERE f.id_operacao=op.id_operacao) AS qtd_pagtos,(SELECT ISNULL(SUM(f.valor),0) FROM dbo.finalizador_operacao_pdv f WHERE f.id_operacao=op.id_operacao) AS total_pagto FROM dbo.operacao_pdv op WHERE op.operacao=1 AND op.cancelado=0 AND op.data_hora_termino IS NOT NULL ORDER BY op.data_hora_termino DESC") "vendas_detalhe"; "" | Out-File $Out -Append; "=" * 70 | Out-File $Out -Append; "  FIM DO DIAGNOSTICO - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File $Out -Append; "=" * 70 | Out-File $Out -Append; Write-Host "`nPRONTO! Resultado salvo em: $Out" -ForegroundColor Green; Start-Process notepad.exe $Out
