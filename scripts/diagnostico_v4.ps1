$Out = "C:\diag.txt"; $Sv = "localhost\HIPER"; function Qr($db, $q) { try { $c = New-Object System.Data.SqlClient.SqlConnection("Server=$Sv;Database=$db;Integrated Security=True;TrustServerCertificate=True;Connection Timeout=15;"); $c.Open(); $cmd = $c.CreateCommand(); $cmd.CommandText = $q; $cmd.CommandTimeout = 60; $a = New-Object System.Data.SqlClient.SqlDataAdapter($cmd); $d = New-Object System.Data.DataSet; [void]$a.Fill($d); $c.Close(); if ($d.Tables.Count -gt 0 -and $d.Tables[0].Rows.Count -gt 0) { return , $d.Tables[0] }else { return $null } }catch { return "ERRO:$($_.Exception.Message)" } }; function Wr($t, $d, $l) { "`n$("="*60)" | Add-Content $Out; "  $t" | Add-Content $Out; if ($d -is [string]) { "  $l => $d" | Add-Content $Out }elseif ($null -eq $d) { "  $l => (vazio)" | Add-Content $Out }else { "  $l ($($d.Rows.Count) rows):" | Add-Content $Out; ($d | Format-Table -AutoSize | Out-String -Width 250) | Add-Content $Out } }; function Chk($db, $tbl, $col) { try { $r = Qr $db "SELECT TOP 1 [$col] FROM dbo.[$tbl]"; if ($r -is [string]) { "N" }elseif ($null -eq $r) { "?" }else { "S" } }catch { "N" } }; "DIAG v4 - $(Get-Date -F 'yyyy-MM-dd HH:mm:ss') - $env:COMPUTERNAME - Server: $Sv" | Set-Content $Out; Wr "1.CONECTIVIDADE" (Qr "HiperPdv" "SELECT DB_NAME() AS db,'OK' AS status") "HiperPdv"; Wr "1.CONECTIVIDADE" (Qr "Hiper" "SELECT DB_NAME() AS db,'OK' AS status") "Gestao"; Wr "2.STORE INFO" (Qr "HiperPdv" "SELECT id_ponto_venda,apelido,cnpj FROM dbo.ponto_venda ORDER BY id_ponto_venda") "ponto_venda"; Wr "3.SCHEMA TURNO PDV" (Qr "HiperPdv" "SELECT COLUMN_NAME,DATA_TYPE,IS_NULLABLE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='turno' ORDER BY ORDINAL_POSITION") "cols"; Wr "3.SCHEMA TURNO GESTAO" (Qr "Hiper" "SELECT COLUMN_NAME,DATA_TYPE,IS_NULLABLE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='turno' ORDER BY ORDINAL_POSITION") "cols"; Wr "4.SCHEMA OPERACAO_PDV - PDV" (Qr "HiperPdv" "SELECT COLUMN_NAME,DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='operacao_pdv' ORDER BY ORDINAL_POSITION") "cols"; Wr "4.SCHEMA OPERACAO_PDV - GESTAO" (Qr "Hiper" "SELECT COLUMN_NAME,DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='operacao_pdv' ORDER BY ORDINAL_POSITION") "cols"; $cc = @(@("HiperPdv", "operacao_pdv", "origem"), @("Hiper", "operacao_pdv", "origem"), @("HiperPdv", "operacao_pdv", "id_filial"), @("Hiper", "operacao_pdv", "id_filial"), @("HiperPdv", "operacao_pdv", "id_ponto_venda"), @("Hiper", "operacao_pdv", "id_ponto_venda"), @("HiperPdv", "operacao_pdv", "ValorTroco"), @("Hiper", "operacao_pdv", "ValorTroco"), @("HiperPdv", "operacao_pdv", "id_turno"), @("Hiper", "operacao_pdv", "id_turno"), @("HiperPdv", "finalizador_operacao_pdv", "valor_troco"), @("Hiper", "finalizador_operacao_pdv", "valor_troco")); "" | Add-Content $Out; "  COLUNAS CRITICAS:" | Add-Content $Out; foreach ($c in $cc) { $ok = "?"; try { $r = Qr $c[0] "SELECT TOP 1 [$($c[2])] FROM dbo.$($c[1])"; if ($r -is [string]) { $ok = "N" }elseif ($null -eq $r) { $ok = "?" }else { $ok = "S" } }catch { $ok = "N" }; "  $($c[0]).$($c[1]).$($c[2]) = $ok" | Add-Content $Out }; Wr "5.TURNOS PDV (ultimos 15)" (Qr "HiperPdv" "SELECT TOP 15 CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.id_ponto_venda,t.sequencial,t.fechado,CONVERT(VARCHAR(19),t.data_hora_inicio,120) AS inicio,CONVERT(VARCHAR(19),t.data_hora_termino,120) AS termino,u.nome AS operador,u.login FROM dbo.turno t LEFT JOIN dbo.usuario u ON u.id_usuario=t.id_usuario ORDER BY t.data_hora_inicio DESC") "turnos"; Wr "5.TURNOS GESTAO (ultimos 15)" (Qr "Hiper" "SELECT TOP 15 CONVERT(VARCHAR(36),t.id_turno) AS id_turno,t.id_filial,t.sequencial,t.fechado,CONVERT(VARCHAR(19),t.data_hora_inicio,120) AS inicio,CONVERT(VARCHAR(19),t.data_hora_termino,120) AS termino,u.nome AS operador,u.login FROM dbo.turno t LEFT JOIN dbo.usuario u ON u.id_usuario=t.id_usuario ORDER BY t.data_hora_inicio DESC") "turnos"; $tp = Qr "HiperPdv" "SELECT TOP 30 CONVERT(VARCHAR(36),id_turno) AS id_turno FROM dbo.turno ORDER BY data_hora_inicio DESC"; if ($tp -isnot [string] -and $null -ne $tp) { $ids = ($tp.Rows | ForEach-Object { "'$($_.id_turno)'" }) -join ","; $mc = Qr "Hiper" "SELECT COUNT(*) AS n FROM dbo.turno WHERE CONVERT(VARCHAR(36),id_turno) IN ($ids)"; $nf = 0; if ($mc -isnot [string] -and $null -ne $mc) { if ($mc -is [System.Data.DataTable]) { $nf = [int]$mc.Rows[0].n }else { $nf = [int]$mc.n } }; "`n  === TESTE PRINCIPAL: TURNOS COMPARTILHADOS? ===" | Add-Content $Out; "  PDV->Gestao: $nf de $($tp.Rows.Count) encontrados" | Add-Content $Out; if ($nf -eq 0) { "  >>> IDs COMPLETAMENTE DIFERENTES" | Add-Content $Out }elseif ($nf -eq $tp.Rows.Count) { "  >>> IDs COMPARTILHADOS" | Add-Content $Out }else { "  >>> PARCIAL $nf/$($tp.Rows.Count)" | Add-Content $Out } }; $tg = Qr "Hiper" "SELECT TOP 30 CONVERT(VARCHAR(36),id_turno) AS id_turno FROM dbo.turno ORDER BY data_hora_inicio DESC"; if ($tg -isnot [string] -and $null -ne $tg) { $ids2 = ($tg.Rows | ForEach-Object { "'$($_.id_turno)'" }) -join ","; $mc2 = Qr "HiperPdv" "SELECT COUNT(*) AS n FROM dbo.turno WHERE CONVERT(VARCHAR(36),id_turno) IN ($ids2)"; $nf2 = 0; if ($mc2 -isnot [string] -and $null -ne $mc2) { if ($mc2 -is [System.Data.DataTable]) { $nf2 = [int]$mc2.Rows[0].n }else { $nf2 = [int]$mc2.n } }; "  Gestao->PDV: $nf2 de $($tg.Rows.Count) encontrados" | Add-Content $Out }; Wr "6.TOTAL TURNOS" (Qr "HiperPdv" "SELECT 'PDV' AS db,COUNT(*) AS total,SUM(CAST(fechado AS INT)) AS fechados FROM dbo.turno") "pdv"; Wr "6.TOTAL TURNOS" (Qr "Hiper" "SELECT 'Gestao' AS db,COUNT(*) AS total,SUM(CAST(fechado AS INT)) AS fechados FROM dbo.turno") "gestao"; $hasOr = $false; $to = Qr "Hiper" "SELECT TOP 1 origem FROM dbo.operacao_pdv"; if ($to -isnot [string] -and $null -ne $to) { $hasOr = $true; "  >>> origem EXISTE (SELECT direto OK)" | Add-Content $Out }else { "  >>> origem NAO existe" | Add-Content $Out }; Wr "7.VENDAS PDV" (Qr "HiperPdv" "SELECT COUNT(*) AS total FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND data_hora_termino IS NOT NULL") "vendas"; if ($hasOr) { Wr "7.VENDAS POR ORIGEM (Gestao)" (Qr "Hiper" "SELECT origem,CASE origem WHEN 0 THEN 'tipo0' WHEN 1 THEN 'PDV/Caixa' WHEN 2 THEN 'Loja' ELSE 'outro' END AS tipo,COUNT(*) AS total FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 GROUP BY origem ORDER BY origem") "vendas"; Wr "8.VENDAS LOJA (origem=2)" (Qr "Hiper" "SELECT TOP 15 op.id_operacao,CONVERT(VARCHAR(36),op.id_turno) AS turno,op.id_filial,CONVERT(VARCHAR(19),op.data_hora_termino,120) AS data,op.origem,u.nome AS vendedor,u.login FROM dbo.operacao_pdv op LEFT JOIN dbo.usuario u ON u.id_usuario=op.id_usuario WHERE op.operacao=1 AND op.cancelado=0 AND op.origem=2 AND op.data_hora_termino IS NOT NULL ORDER BY op.data_hora_termino DESC") "loja"; $vl = Qr "Hiper" "SELECT DISTINCT TOP 10 CONVERT(VARCHAR(36),id_turno) AS tid FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND origem=2 AND data_hora_termino IS NOT NULL AND id_turno IS NOT NULL ORDER BY tid"; if ($vl -isnot [string] -and $null -ne $vl) { $idl = ($vl.Rows | ForEach-Object { "'$($_.tid)'" }) -join ","; $fg = Qr "Hiper" "SELECT COUNT(*) AS n FROM dbo.turno WHERE CONVERT(VARCHAR(36),id_turno) IN ($idl)"; $fp = Qr "HiperPdv" "SELECT COUNT(*) AS n FROM dbo.turno WHERE CONVERT(VARCHAR(36),id_turno) IN ($idl)"; $ng = 0; $np = 0; if ($fg -isnot [string] -and $null -ne $fg) { if ($fg -is [System.Data.DataTable]) { $ng = [int]$fg.Rows[0].n }else { $ng = [int]$fg.n } }; if ($fp -isnot [string] -and $null -ne $fp) { if ($fp -is [System.Data.DataTable]) { $np = [int]$fp.Rows[0].n }else { $np = [int]$fp.n } }; "  Turnos vendas Loja no Gestao: $ng de $($vl.Rows.Count)" | Add-Content $Out; "  Turnos vendas Loja no PDV: $np de $($vl.Rows.Count)" | Add-Content $Out }; Wr "8B.VENDAS LOJA POR FILIAL" (Qr "Hiper" "SELECT id_filial,COUNT(*) AS vendas FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND origem=2 GROUP BY id_filial ORDER BY id_filial") "filial" }else { Wr "7.VENDAS GESTAO (sem origem)" (Qr "Hiper" "SELECT COUNT(*) AS total FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND data_hora_termino IS NOT NULL") "vendas" }; Wr "9.OPS POR TIPO (PDV)" (Qr "HiperPdv" "SELECT operacao,CASE operacao WHEN 0 THEN 'Abertura' WHEN 1 THEN 'Venda' WHEN 3 THEN 'Sangria' WHEN 4 THEN 'Falta' WHEN 9 THEN 'Fechamento' ELSE CAST(operacao AS VARCHAR) END AS tipo,COUNT(*) AS total FROM dbo.operacao_pdv WHERE cancelado=0 GROUP BY operacao ORDER BY operacao") "ops"; Wr "9.OPS POR TIPO (Gestao)" (Qr "Hiper" "SELECT operacao,CASE operacao WHEN 0 THEN 'Abertura' WHEN 1 THEN 'Venda' WHEN 3 THEN 'Sangria' WHEN 4 THEN 'Falta' WHEN 9 THEN 'Fechamento' ELSE CAST(operacao AS VARCHAR) END AS tipo,COUNT(*) AS total FROM dbo.operacao_pdv WHERE cancelado=0 GROUP BY operacao ORDER BY operacao") "ops"; Wr "10.FECHAMENTOS GESTAO" (Qr "Hiper" "SELECT TOP 5 CONVERT(VARCHAR(36),op.id_turno) AS turno,op.id_filial,CONVERT(VARCHAR(19),op.data_hora_termino,120) AS data FROM dbo.operacao_pdv op WHERE op.operacao=9 AND op.cancelado=0 ORDER BY op.data_hora_termino DESC") "fechamentos"; Wr "11.TURNOS GESTAO COM VENDAS" (Qr "Hiper" "SELECT TOP 5 t.id_filial,CONVERT(VARCHAR(36),t.id_turno) AS turno,t.sequencial,CONVERT(VARCHAR(19),t.data_hora_inicio,120) AS inicio,CONVERT(VARCHAR(19),t.data_hora_termino,120) AS termino,(SELECT COUNT(*) FROM dbo.operacao_pdv op WHERE op.id_turno=t.id_turno AND op.operacao=1 AND op.cancelado=0) AS vendas,(SELECT COUNT(*) FROM dbo.operacao_pdv op WHERE op.id_turno=t.id_turno AND op.operacao=9 AND op.cancelado=0) AS fechamentos FROM dbo.turno t WHERE t.fechado=1 ORDER BY t.data_hora_inicio DESC") "turnos"; Wr "12.FINALIZADORES PDV" (Qr "HiperPdv" "SELECT id_finalizador,nome FROM dbo.finalizador_pdv ORDER BY id_finalizador") "meios"; Wr "12.FINALIZADORES GESTAO" (Qr "Hiper" "SELECT DISTINCT id_finalizador,nome FROM dbo.finalizador_pdv ORDER BY id_finalizador") "meios"; Wr "13.USUARIOS PDV" (Qr "HiperPdv" "SELECT TOP 10 id_usuario,nome,login FROM dbo.usuario ORDER BY id_usuario") "users"; Wr "13.USUARIOS GESTAO" (Qr "Hiper" "SELECT TOP 10 id_usuario,nome,login FROM dbo.usuario ORDER BY id_usuario") "users"; Wr "14.FILIAIS GESTAO" (Qr "Hiper" "SELECT id_filial,COUNT(*) AS turnos,SUM(CAST(fechado AS INT)) AS fechados FROM dbo.turno GROUP BY id_filial ORDER BY id_filial") "filiais"; Wr "15.COLISAO IDs" (Qr "HiperPdv" "SELECT TOP 5 p.id_operacao,CONVERT(VARCHAR(19),p.data_hora_termino,120) AS pdv_data,CONVERT(VARCHAR(19),g.data_hora_termino,120) AS gestao_data FROM [HiperPdv].dbo.operacao_pdv p JOIN [Hiper].dbo.operacao_pdv g ON g.id_operacao=p.id_operacao WHERE p.operacao=1 AND p.cancelado=0 AND g.operacao=1 AND g.cancelado=0 ORDER BY p.data_hora_termino DESC") "colisao"; $dt7 = (Get-Date).AddDays(-7).ToString("yyyy-MM-dd HH:mm:ss"); Wr "16.VOLUME 7D PDV" (Qr "HiperPdv" "SELECT COUNT(*) AS vendas FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND data_hora_termino>='$dt7'") "7d"; if ($hasOr) { Wr "16.VOLUME 7D GESTAO" (Qr "Hiper" "SELECT origem,CASE origem WHEN 1 THEN 'PDV' WHEN 2 THEN 'Loja' ELSE CAST(origem AS VARCHAR) END AS tipo,COUNT(*) AS vendas FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND data_hora_termino>='$dt7' GROUP BY origem ORDER BY origem") "7d" }else { Wr "16.VOLUME 7D GESTAO" (Qr "Hiper" "SELECT COUNT(*) AS vendas FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND data_hora_termino>='$dt7'") "7d" }; Wr "17.ANOMALIAS" (Qr "HiperPdv" "SELECT (SELECT COUNT(*) FROM dbo.operacao_pdv WHERE operacao=1 AND cancelado=0 AND data_hora_termino IS NOT NULL AND NOT EXISTS(SELECT 1 FROM dbo.item_operacao_pdv it WHERE it.id_operacao=dbo.operacao_pdv.id_operacao AND it.cancelado=0)) AS vendas_sem_itens,(SELECT COUNT(*) FROM dbo.item_operacao_pdv it JOIN dbo.operacao_pdv op ON op.id_operacao=it.id_operacao WHERE op.operacao=1 AND op.cancelado=0 AND it.cancelado=0 AND it.id_usuario_vendedor IS NULL) AS itens_sem_vendedor,(SELECT COUNT(*) FROM dbo.operacao_pdv WHERE data_hora_termino>GETDATE() AND operacao=1 AND cancelado=0) AS data_futura,(SELECT COUNT(*) FROM dbo.turno WHERE fechado=1 AND DATEDIFF(MINUTE,data_hora_inicio,data_hora_termino)<5) AS turnos_curtos") "anomalias"; "`n$("="*60)" | Add-Content $Out; "  FIM - $(Get-Date -F 'yyyy-MM-dd HH:mm:ss')" | Add-Content $Out; Write-Host "`nPRONTO! => $Out" -ForegroundColor Green; notepad $Out
